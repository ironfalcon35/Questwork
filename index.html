<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Questwork</title>
  <!-- App Icons -->
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
  
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">

<style>
  :root{
    --card-bg: rgba(0,0,0,0.6);
    --text:#fff;
    --accent:#ffdd57;
    --btnA:#ff6a00; --btnB:#ee0979;
  }
  body{
    margin:0; font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
    background:linear-gradient(135deg,#1f1c2c 0%,#928DAB 100%);
    color:var(--text);
    min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
    transition:background 0.5s ease, color .3s ease;
  }
  .card{ background:var(--card-bg); padding:20px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.4); max-width:760px; width:95%; margin:10px; animation:fadeIn .5s ease-in; }
  h2,h3{ margin-top:0; color:var(--accent); text-shadow:1px 1px 4px #000; }
  input,button,select{ width:90%; padding:12px; margin:8px 0; border-radius:8px; border:none; font-size:1rem; outline:none; }
  input{ background:#f4f4f4; }
  button{ background:linear-gradient(135deg,var(--btnA),var(--btnB)); color:#fff; font-weight:bold; cursor:pointer; transition:transform .2s, opacity .3s; }
  button:hover{ transform:scale(1.05); opacity:.9; }
  .hidden{ display:none; }

  #wheelBox{ margin:20px auto; width:260px; height:64px; overflow:hidden; border:3px solid #fff; border-radius:8px; background:rgba(0,0,0,.8); display:flex; justify-content:center; align-items:center; }
  .prizeText{ font-size:1.4rem; font-weight:bold; transition:transform .15s ease; }

  #inventory,#collectibles{ list-style:none; padding:0; margin:0; max-height:180px; overflow-y:auto; }
  #inventory li,#collectibles li{ background:rgba(255,255,255,.1); margin:5px 0; padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; gap:8px; }
  .delete-btn{ background:crimson; color:#fff; border:none; border-radius:6px; padding:3px 8px; cursor:pointer; font-size:.8rem; }

  /* Theme classes (easy to customize) */
  .theme-blackness{ background:#000; color:#fff; }
  .theme-checker{ background:url('https://i.imgur.com/x9JEZ61.png') repeat; }
  .theme-bw{ background:linear-gradient(90deg,#000,#fff); color:#fff; }
  .theme-neon{ background:linear-gradient(135deg,#0f0f0f,#00ffcc); }
  .theme-space{ background:#000 url('https://i.imgur.com/CbK7Ogy.png') center/cover no-repeat; font-family:'Optima', regular; }
  .theme-time{ background:#d1c145 url('https://i.imgur.com/wJDrRrf.png') center/cover no-repeat; font-family:'Gill Sans', regular; }
  .theme-forest{ background:#000 url('https://i.imgur.com/HzTwfvV.png') center/cover no-repeat; font-family:'Trattatello', regular; }
  .theme-desert{ background:#000 url('https://i.imgur.com/y6spIo8.png') center/cover no-repeat; }
  .theme-cyber{ background:#000 url('https://i.imgur.com/OMSBJoH.png') center/cover no-repeat; font-family:'Optima', regular; }
  .theme-music{ background:#111 url('https://i.imgur.com/uldGxyn.png') center/cover no-repeat; font-family:'Georgia', regular; }
  .theme-ice{ background:#111 url('https://i.imgur.com/NoMHwCU.png') center/cover no-repeat; }
  .theme-underwater{ background:#111 url('https://i.imgur.com/kPsUNG2.png') center/cover no-repeat; font-family:'Chalkboard', regular; }
  .theme-dog{ background:url('https://i.imgur.com/h6KGr0v.png') center/cover no-repeat; font-family:'Annai MN', regular; }
  .theme-undertale{ background:#000 url('https://i.imgur.com/b8Pni9x.png') center/cover no-repeat; color:#fff; font-family: 'Press Start 2P', 'Courier New', Courier, monospace; }
  .theme-castle{ background:url('https://i.imgur.com/dVZ0pgd.png') center/cover no-repeat; font-family:'Luminari', regular; }
  .theme-amazing{ background:#000 url('https://i.imgur.com/5aXp1BS.png') center/cover no-repeat; font-family:'Comic Sans MS', regular; } 
  .theme-pirate{ background:url('https://i.imgur.com/OM5jOIc.png') center/cover no-repeat; font-family: 'IM Fell English SC', 'serif'; }

  @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
  @keyframes spinAnim{ from{ transform:rotate(0deg) scale(.5); opacity:0;} to{ transform:rotate(720deg) scale(1); opacity:1;} }
  .collectible-spin { 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  animation: spinAnim 1s ease forwards; 
  z-index: 9999; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  width: 220px; 
  height: 220px; 
  background: rgba(0,0,0,.6); 
  border: 3px solid #fff; 
  border-radius: 16px; 
  box-shadow: 0 12px 40px rgba(0,0,0,.6); 
}

  .collectible-spin img{ max-width:180px; max-height:180px; }
  .collectible-spin .label{ position:absolute; bottom:-36px; left:50%; transform:translateX(-50%); font-weight:700; background:rgba(0,0,0,.7); padding:6px 10px; border-radius:10px; border:1px solid #fff; }

  #teacherLoginBtn{ width:auto; padding:6px 12px; font-size:.9rem; margin-top:15px; background:linear-gradient(135deg,#555,#999); }
  #teacherPanel{ margin-top:20px; }
  #testOutput{ text-align:left; background:rgba(0,0,0,.4); padding:10px; border-radius:10px; white-space:pre-wrap; max-height:200px; overflow:auto; }
</style>
</head>
<body>
  <div class="card" id="loginCard">
    <h2>Questwork Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()">Sign In</button>
  </div>

  <div class="card hidden" id="gameBox">
    <h2>Welcome, <span id="playerName"></span>!</h2>
    <p>⭐ Points: <span id="points">0</span></p>

    <div id="wheelButtons">
      <button onclick="spin()">Spin Wheel (50 pts)</button>
    </div>

    <div id="wheelBox"><div class="prizeText" id="prizeDisplay">?</div></div>
    <p id="result"></p>

    <h3>Inventory</h3>
    <ul id="inventory"></ul>

    <h3>Collectibles</h3>
    <ul id="collectibles"></ul>

    <h3>Pokémon</h3>
<ul id="pokemonList"></ul>

<h3>Collectibles Progress</h3>
<div style="width:90%; background:rgba(255,255,255,0.2); border-radius:8px; overflow:hidden; margin-bottom:10px;">
  <div id="collectiblesProgressBar" style="height:20px; width:0%; background:var(--accent); text-align:center; color:#000; font-weight:bold; line-height:20px;">0%</div>
</div>
<p id="collectiblesProgressText">0 / 0 (0%)</p>

<h3>Pokémon Progress</h3>
<div style="width:90%; background:rgba(255,255,255,0.2); border-radius:8px; overflow:hidden; margin-bottom:10px;">
  <div id="pokemonProgressBar" style="height:20px; width:0%; background:var(--btnA); text-align:center; color:#000; font-weight:bold; line-height:20px;">0%</div>
</div>
<p id="pokemonProgressText">0 / 0 (0%)</p>

    <h3>Theme Selector</h3>
    <select id="themeSelect" onchange="applyTheme(this.value)">
      <option value="">--Choose Theme--</option>
    </select>

    <!-- Teacher toggle -->
    <button id="teacherLoginBtn" onclick="showTeacherLogin()">Teacher</button>
    <div id="teacherPanel" class="hidden">
      <h3>Teacher Controls</h3>
      <input type="number" id="pointsToAdd" placeholder="Points to add" />
      <button onclick="addPoints()">Add Points</button>
      <button onclick="logoutTeacher()">Log Out</button>
      <div style="margin-top:10px">
        <button onclick="runTests()">Run Self-Tests</button>
      </div>
      <div id="testOutput" class="hidden"></div>
    </div>
  </div>

<script>
'use strict';
const TEACHER_SECRET = '7545';

// === Theme catalog (display label + CSS class key) ===
const themeCatalog = {
  blackness: { label: 'Blackness Theme' },
  checker: { label: 'Checker Theme' },
  bw: { label: 'Black and White Theme' },
  neon: { label: 'Neon Theme' },
  space: { label: 'Space Theme' },
  time: { label: 'Time Theme' },
  forest: { label: 'Forest Theme' },
  desert: { label: 'Desert Theme' },
  cyber: { label: 'Cyber Theme' },
  music: { label: 'Music Theme' },
  ice: { label: 'Ice Theme' },
  underwater: { label: 'Underwater Theme' },
  dog: { label: 'Dog Theme' },
  undertale: { label: 'Undertale Theme' },
  castle: { label: 'Castle Theme' },
  amazing: { label: 'Amazing Digital Theme' },
  pirate: { label: 'Pirate Theme' },
};

// === Collectible image lookup (fallbacks used if not found) ===
const collectibleImages = {
  'Game Theory Collectible': 'https://i.imgur.com/m8K0vns.png',
  'Film Theory Collectible': 'https://i.imgur.com/tiKfr2b.png',
  'Food Theory Collectible': 'https://i.imgur.com/BDSdhLd.png',
  'Style Theory Collectible': 'https://i.imgur.com/0wtEAkH.png',
  'Shopping Cart Collectible': 'https://i.imgur.com/GUU94Nd.png',
  'Bad Time Collectible': 'https://i.imgur.com/s8UNppm.png',
  'Sussy Imposter Collectible': 'https://i.imgur.com/KIrh66U.png',   
  'Pirate King Collectible': 'https://i.imgur.com/NMasPta.png',   
  'Black Knight Collectible': 'https://i.imgur.com/1sfEzio.png',   
  'Cheese Collectible': 'https://i.imgur.com/JIlzeJ4.png',   
  'Nyan Cat Collectible': 'https://i.imgur.com/F2cFTGU.png', 
  'Epic Sax Collectible': 'https://i.imgur.com/Mat8wsI.png', 
  'Doge Crown Collectible': 'https://i.imgur.com/QeyMp2L.png',
  'Pepe Collectible': 'https://i.imgur.com/MHQCJmw.png',
  'Noob Collectible': 'https://i.imgur.com/W999p7P.png',
  'Pokeball': 'https://i.imgur.com/ySofbkn.png'
};

// === Gen 1 Pokémon list (151) ===
const POKEMON_GEN1 = [
  'Bulbasaur','Ivysaur','Venusaur','Charmander','Charmeleon','Charizard','Squirtle','Wartortle','Blastoise','Caterpie','Metapod','Butterfree','Weedle','Kakuna','Beedrill','Pidgey','Pidgeotto','Pidgeot','Rattata','Raticate','Spearow','Fearow','Ekans','Arbok','Pikachu','Raichu','Sandshrew','Sandslash','Nidoran♀','Nidorina','Nidoqueen','Nidoran♂','Nidorino','Nidoking','Clefairy','Clefable','Vulpix','Ninetales','Jigglypuff','Wigglytuff','Zubat','Golbat','Oddish','Gloom','Vileplume','Paras','Parasect','Venonat','Venomoth','Diglett','Dugtrio','Meowth','Persian','Psyduck','Golduck','Mankey','Primeape','Growlithe','Arcanine','Poliwag','Poliwhirl','Poliwrath','Abra','Kadabra','Alakazam','Machop','Machoke','Machamp','Bellsprout','Weepinbell','Victreebel','Tentacool','Tentacruel','Geodude','Graveler','Golem','Ponyta','Rapidash','Slowpoke','Slowbro','Magnemite','Magneton','Farfetch’d','Doduo','Dodrio','Seel','Dewgong','Grimer','Muk','Shellder','Cloyster','Gastly','Haunter','Gengar','Onix','Drowzee','Hypno','Krabby','Kingler','Voltorb','Electrode','Exeggcute','Exeggutor','Cubone','Marowak','Hitmonlee','Hitmonchan','Lickitung','Koffing','Weezing','Rhyhorn','Rhydon','Chansey','Tangela','Kangaskhan','Horsea','Seadra','Goldeen','Seaking','Staryu','Starmie','Mr. Mime','Scyther','Jynx','Electabuzz','Magmar','Pinsir','Tauros','Magikarp','Gyarados','Lapras','Ditto','Eevee','Vaporeon','Jolteon','Flareon','Porygon','Omanyte','Omastar','Kabuto','Kabutops','Aerodactyl','Snorlax','Articuno','Zapdos','Moltres','Dratini','Dragonair','Dragonite','Mewtwo','Mew'
];

// === Prize pool base ===
const wheelPrizesBase = [
  // Physical prizes (stackable, no refund)
  { name:'Lollipop', weight:40, type:'physical' },
  { name:'Sticker', weight:30, type:'physical' },
  { name:'Do 10 Pushups Lol', weight:10, type:'physical' },
  { name:'Do a thingy with Ezra', weight:5, type:'physical' },

  // Themes (refund 25 on duplicate)
  { name:'Blackness Theme', weight:100, type:'theme', themeKey:'blackness' },
  { name:'Checker Theme', weight:100, type:'theme', themeKey:'checker' },
  { name:'Black and White Theme', weight:100, type:'theme', themeKey:'bw' },
  { name:'Neon Theme', weight:90, type:'theme', themeKey:'neon' },
  { name:'Space Theme', weight:80, type:'theme', themeKey:'space' },
  { name:'Time Theme', weight:70, type:'theme', themeKey:'time' },
  { name:'Forest Theme', weight:60, type:'theme', themeKey:'forest' },
  { name:'Desert Theme', weight:50, type:'theme', themeKey:'desert' },
  { name:'Cyber Theme', weight:40, type:'theme', themeKey:'cyber' },
  { name:'Music Theme', weight:30, type:'theme', themeKey:'music' },
  { name:'Ice Theme', weight:15, type:'theme', themeKey:'ice' },
  { name:'Underwater Theme', weight:15, type:'theme', themeKey:'underwater' },
  { name:'Dog Theme', weight:5, type:'theme', themeKey:'dog' },
  { name:'Undertale Theme', weight:4, type:'theme', themeKey:'undertale' },
  { name:'Castle Theme', weight:3, type:'theme', themeKey:'castle' },
  { name:'Amazing Digital Theme', weight:2, type:'theme', themeKey:'amazing' },
  { name:'Pirate Theme', weight:1, type:'theme', themeKey:'pirate' },

  // Non-Pokémon Collectibles (refund 25 on duplicate)
  { name:'Pirate King Collectible', weight:1, type:'collectible' },
  { name:'Black Knight Collectible', weight:2, type:'collectible' },
  { name:'Doge Crown Collectible', weight:4, type:'collectible' },
  { name:'Pepe Collectible', weight:8, type:'collectible' },
  { name:'Sussy Imposter Collectible', weight:10, type:'collectible' },
  { name:'Nyan Cat Collectible', weight:15, type:'collectible' },
  { name:'Bad Time Collectible', weight:20, type:'collectible' },
  { name:'Epic Sax Collectible', weight:25, type:'collectible' },
  { name:'Noob Collectible', weight:30, type:'collectible' },
  { name:'Shopping Cart Collectible', weight:35, type:'collectible' },
  { name:'Film Theory Collectible', weight:20, type:'collectible' },
  { name:'Game Theory Collectible', weight:15, type:'collectible' },
  { name:'Food Theory Collectible', weight:15, type:'collectible' },
  { name:'Style Theory Collectible', weight:15, type:'collectible' },
  { name:'Cheese Collectible', weight:10, type:'collectible' },

  // Points
  { name:'50 Points', weight:10, type:'points', amount:50 },
  { name:'100 Points', weight:5, type:'points', amount:100 },
];

// Add all Gen 1 Pokémon (each weight 5)
const wheelPrizes = wheelPrizesBase.concat(
  POKEMON_GEN1.map(p => ({ name:p, weight:3, type:'pokemon' }))
);

// === Storage ===
let accounts = JSON.parse(localStorage.getItem('accounts')) || {};
let currentUser = null;
let teacherMode = false;

function saveData(){ localStorage.setItem('accounts', JSON.stringify(accounts)); }

// === Auth ===
function signup(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if(!u || !p) return alert('Enter username and password.');
  if(accounts[u]) return alert('Account exists!');
  accounts[u] = { password:p, points:0, inventory:[], themes:[], selectedTheme:'', collectibles:[] };
  saveData(); currentUser = u; startGame();
}
function login(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if(!accounts[u]) return alert('No account. Sign up first.');
  if(accounts[u].password !== p) return alert('Wrong password.');
  currentUser = u; startGame();
}

function startGame(){
  document.getElementById('playerName').innerText = currentUser;
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('gameBox').classList.remove('hidden');
  updateUI();
}

// === Utils ===
function weightedRandom(items){
  if(!items || !items.length) return null;
  const total = items.reduce((s,i)=>s+i.weight,0);
  let r = Math.random()*total;
  for(const i of items){ if(r < i.weight) return i; r -= i.weight; }
  return items[items.length-1];
}

function getAvailablePrizesFor(acc){
  return wheelPrizes.filter(p => {
    if(p.type === 'pokemon' && acc.collectibles.includes(p.name)) return false; // exclude owned Pokémon
    return true;
  });
}
function getAvailablePrizes(){
  return getAvailablePrizesFor(accounts[currentUser]);
}

// Pure prize application (for tests). Returns { nextAcc, message }
function applyPrizePure(acc, prize){
  const next = JSON.parse(JSON.stringify(acc));
  let msg = '';
  if(!prize) return { nextAcc:next, message:'No prize available.' };

  if(prize.type === 'physical'){
    next.inventory.push(prize.name);
    msg = `🎉 You won: ${prize.name}`;
  } else if(prize.type === 'points'){
    next.points += prize.amount;
    msg = `🎉 You won: ${prize.amount} points!`;
  } else if(prize.type === 'theme'){
    const key = prize.themeKey;
    if(next.themes.includes(key)) { next.points += 25; msg = 'Duplicate theme! Refunded 25 pts.'; }
    else { next.themes.push(key); msg = `🎉 New theme: ${prize.name}`; }
  } else if(prize.type === 'collectible' || prize.type === 'pokemon'){
    if(next.collectibles.includes(prize.name)) { next.points += 25; msg = 'Duplicate collectible! Refunded 25 pts.'; }
    else { next.collectibles.push(prize.name); msg = `🎉 New collectible: ${prize.name}`; }
  }
  return { nextAcc: next, message: msg };
}

function spin(){
  const acc = accounts[currentUser];
  if(acc.points < 50) return alert('Not enough points!');
  acc.points -= 50;

  const available = getAvailablePrizes();
  const prize = weightedRandom(available);

  const prizeDisplay = document.getElementById('prizeDisplay');
  const result = document.getElementById('result');

  let flips = 50, step = 0, interval = 75;
  const anim = setInterval(()=>{
    step++;
    const fake = available[Math.floor(Math.random()*available.length)]?.name || '?';
    prizeDisplay.innerText = fake;
    const scale = 1 + 0.2*Math.sin(step*0.8);
    prizeDisplay.style.transform = `scale(${scale})`;
    if(step >= flips){
      clearInterval(anim);
      prizeDisplay.innerText = prize ? prize.name : 'No Prize';
      prizeDisplay.style.transform = 'scale(1)';

      const { nextAcc, message } = applyPrizePure(acc, prize);
      // commit the pure result to the real account
      accounts[currentUser] = nextAcc;
      result.innerText = message;
      updateUI();
    }
  }, interval);
}

function updateUI(){
  const acc = accounts[currentUser];
  if(!acc) return;

  document.getElementById('points').innerText = acc.points;

  // Inventory list
  const inv = document.getElementById('inventory'); 
  inv.innerHTML = '';
  acc.inventory.forEach((item, idx)=>{
    const li = document.createElement('li'); 
    li.innerText = item;
    const del = document.createElement('button'); 
    del.innerText='x'; 
    del.className='delete-btn';
    del.onclick = ()=>{
      acc.inventory.splice(idx,1); 
      saveData(); 
      updateUI();
    };
    li.appendChild(del); 
    inv.appendChild(li);
  });

  // Split collectibles into non-Pokémon & Pokémon
  const nonPokemon = acc.collectibles.filter(c => !POKEMON_GEN1.includes(c));
  const pokes = acc.collectibles.filter(c => POKEMON_GEN1.includes(c));

  // Non-Pokémon collectibles list
  const coll = document.getElementById('collectibles'); 
  coll.innerHTML = '';
  nonPokemon.forEach((c)=>{
    const li = document.createElement('li');
    li.innerHTML = `<span>${c}</span>`;
    li.onclick = ()=>showCollectible(c);
    coll.appendChild(li);
  });

  // Pokémon list (separate category)
  const pokeUL = document.getElementById('pokemonList');
  if (pokeUL){
    pokeUL.innerHTML = '';
    pokes.forEach((p)=>{
      const li = document.createElement('li');
      li.innerHTML = `<span>${p}</span>`;
      li.onclick = ()=>showCollectible(p);
      pokeUL.appendChild(li);
    });
  }

  // Theme selector
  const themeSelect = document.getElementById('themeSelect');
  themeSelect.innerHTML = "<option value=''>--Choose Theme--</option>";
  acc.themes.forEach(key=>{
    const meta = themeCatalog[key]; 
    if(!meta) return;
    const opt = document.createElement('option');
    opt.value = key; 
    opt.innerText = meta.label; 
    if(key===acc.selectedTheme) opt.selected = true;
    themeSelect.appendChild(opt);
  });

  if(acc.selectedTheme) applyTheme(acc.selectedTheme);

  saveData();

  // Update progress bars last (now that elements exist)
  updateProgressBars();
}

function updateProgressBars(){
  const acc = accounts[currentUser];
  if(!acc) return;

  // Collectibles progress
  const totalCollectibles = wheelPrizes.filter(p=>p.type==='collectible').length;
  const ownedCollectibles = acc.collectibles.filter(c=>{
    return wheelPrizes.some(p=>p.name===c && p.type==='collectible');
  }).length;
  const collectPercent = Math.round((ownedCollectibles / totalCollectibles) * 100);
  
  const cBar = document.getElementById('collectiblesProgressBar');
  const cText = document.getElementById('collectiblesProgressText');
  cBar.style.width = collectPercent + '%';
  cBar.textContent = collectPercent + '%';
  cText.textContent = `${ownedCollectibles} / ${totalCollectibles} (${collectPercent}%)`;

  // Pokémon progress
  const totalPokemon = POKEMON_GEN1.length;
  const ownedPokemon = acc.collectibles.filter(c=>POKEMON_GEN1.includes(c)).length;
  const pokePercent = Math.round((ownedPokemon / totalPokemon) * 100);
  
  const pBar = document.getElementById('pokemonProgressBar');
  const pText = document.getElementById('pokemonProgressText');
  pBar.style.width = pokePercent + '%';
  pBar.textContent = pokePercent + '%';
  pText.textContent = `${ownedPokemon} / ${totalPokemon} (${pokePercent}%)`;
}

function applyTheme(themeKey){
  const acc = accounts[currentUser];
  acc.selectedTheme = themeKey || '';
  // remove old theme-* classes
  document.body.className = '';
  if(themeKey) document.body.classList.add('theme-'+themeKey);
  saveData();
}

function showCollectible(name){
  const overlay = document.createElement('div');
  overlay.className = 'collectible-spin';

  // Pick an image if we have one, else use a fallback emoji tile
  let imgURL = collectibleImages[name];
  if(!imgURL && POKEMON_GEN1.includes(name)) imgURL = collectibleImages['Pokeball'];

  if(imgURL){
    const img = document.createElement('img'); 
    img.alt = name; 
    img.src = imgURL; 
    overlay.appendChild(img);
  } else {
    const box = document.createElement('div');
    box.style.width = '180px'; 
    box.style.height='180px'; 
    box.style.borderRadius='12px'; 
    box.style.background='linear-gradient(135deg,#444,#999)';
    box.style.display='flex'; 
    box.style.alignItems='center'; 
    box.style.justifyContent='center'; 
    box.style.fontSize='64px';
    box.textContent = '🎁'; 
    overlay.appendChild(box);
  }

  const label = document.createElement('div'); 
  label.className='label'; 
  label.textContent = name; 
  overlay.appendChild(label);

  // ⭐ Play sound when collectible shows
  const sfx = document.getElementById('collectibleSound');
  if(sfx){ 
    sfx.currentTime = 0; 
    sfx.play().catch(()=>{}); 
  }

  document.body.appendChild(overlay);
  setTimeout(()=> overlay.remove(), 1200);
}

// === Teacher controls ===
function showTeacherLogin(){
  if(teacherMode) return; // already logged in
  const code = prompt('Enter teacher code:');
  if(code === TEACHER_SECRET){
    teacherMode = true;
    document.getElementById('teacherPanel').classList.remove('hidden');
    document.getElementById('teacherLoginBtn').classList.add('hidden');
  } else {
    alert('Wrong code!');
  }
}
function addPoints(){
  const amt = parseInt(document.getElementById('pointsToAdd').value,10);
  if(teacherMode && amt>0){ accounts[currentUser].points += amt; saveData(); updateUI(); alert('Added '+amt+' points!'); }
  else alert('Enter a valid amount!');
}
function logoutTeacher(){
  teacherMode = false;
  document.getElementById('teacherPanel').classList.add('hidden');
  document.getElementById('teacherLoginBtn').classList.remove('hidden');
}

// === Self-tests (don’t modify player data) ===
function runTests(){
  if(!teacherMode){ alert('Teacher mode only.'); return; }
  const out = [];
  const base = { password:'x', points:0, inventory:[], themes:[], selectedTheme:'', collectibles:[] };

  // T1: Duplicate theme refunds 25
  let a1 = JSON.parse(JSON.stringify(base)); a1.themes=['neon'];
  let r1 = applyPrizePure(a1,{ name:'Neon Theme', type:'theme', themeKey:'neon' });
  out.push(assert(r1.nextAcc.points===25,'T1 duplicate theme refund 25')); 

  // T2: Physicals stack, no refund
  let a2 = JSON.parse(JSON.stringify(base));
  let r2a = applyPrizePure(a2,{ name:'Lollipop', type:'physical' }).nextAcc;
  let r2b = applyPrizePure(r2a,{ name:'Lollipop', type:'physical' }).nextAcc;
  out.push(assert(r2b.inventory.filter(x=>x==='Lollipop').length===2,'T2 physical stacks'));

  // T3: Duplicate collectible refunds 25
  let a3 = JSON.parse(JSON.stringify(base)); a3.collectibles=['Cheese Collectible'];
  let r3 = applyPrizePure(a3,{ name:'Cheese Collectible', type:'collectible' });
  out.push(assert(r3.nextAcc.points===25,'T3 duplicate collectible refund 25'));

  // T4: Pokémon excluded when owned
  let a4 = JSON.parse(JSON.stringify(base)); a4.collectibles=['Bulbasaur'];
  let avail4 = getAvailablePrizesFor(a4).some(p=>p.name==='Bulbasaur');
  out.push(assert(avail4===false,'T4 pokemon excluded if owned'));

  // T5: Pokémon added to collectibles when new
  let a5 = JSON.parse(JSON.stringify(base));
  let r5 = applyPrizePure(a5,{ name:'Ivysaur', type:'pokemon' });
  out.push(assert(r5.nextAcc.collectibles.includes('Ivysaur'),'T5 pokemon recorded when new'));

  // T6: Theme key mapping works for multi-word label (bw)
  let a6 = JSON.parse(JSON.stringify(base));
  let r6 = applyPrizePure(a6,{ name:'Black and White Theme', type:'theme', themeKey:'bw' });
  out.push(assert(r6.nextAcc.themes.includes('bw'),'T6 theme key stored bw'));

  const panel = document.getElementById('testOutput');
  panel.classList.remove('hidden');
  panel.textContent = out.join('\n');
}
function assert(cond,msg){ return (cond?'✅ PASS: ':'❌ FAIL: ')+msg; }

</script>
  <audio id="collectibleSound" src="https://raw.githubusercontent.com/ironfalcon35/Questwork/main/Batman.mp3" preload="auto"></audio>
</body>
</html>
