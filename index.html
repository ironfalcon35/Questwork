<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Questwork 4.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin:0;
    font-family:'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#1f1c2c 0%,#928DAB 100%);
    color:#fff;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    text-align:center;
    transition:background 0.5s ease;
  }
  .card {
    background: rgba(0,0,0,0.6);
    padding:20px;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
    max-width:550px;
    width:95%;
    margin:10px;
    animation:fadeIn 0.5s ease-in;
  }
  h2,h3{margin-top:0;color:#ffdd57;text-shadow:1px 1px 4px #000;}
  input,button,select{
    width:90%;padding:12px;margin:8px 0;border-radius:8px;border:none;font-size:1rem;outline:none;
  }
  input{background:#f4f4f4;}
  button{
    background: linear-gradient(135deg,#ff6a00,#ee0979);
    color:white;font-weight:bold;cursor:pointer;transition:transform 0.2s,opacity 0.3s;
  }
  button:hover{transform:scale(1.05);opacity:0.9;}
  .hidden{display:none;}
  #inventory{list-style:none;padding:0;margin:0;max-height:150px;overflow-y:auto;}
  #inventory li{
    background: rgba(255,255,255,0.1);
    margin:5px 0;
    padding:8px;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .delete-btn{
    background: crimson;color:white;border:none;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:0.8rem;
  }
  #wheelBox{
    margin:20px auto;
    width:250px;
    height:60px;
    overflow:hidden;
    border:3px solid #fff;
    border-radius:8px;
    background: rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .prizeText{
    font-size:1.4rem;font-weight:bold;
    transition:transform 0.15s ease;
  }
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(10px);}
    to{opacity:1;transform:translateY(0);}
  }
  #dungeonContainer {margin-top:20px;}
  #mobileControls button {margin:2px;}
</style>
</head>
<body>
<div class="card" id="loginCard">
<h2>Questwork Login</h2>
<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">
<button onclick="signup()">Sign Up</button>
<button onclick="login()">Sign In</button>
</div>

<div class="card hidden" id="gameBox">
<h2>Welcome, <span id="playerName"></span>!</h2>
<p>⭐ Points: <span id="points">0</span></p>

<div id="wheelButtons">
<button onclick="spin()">Spin Wheel</button>
</div>

<div id="wheelBox"><div class="prizeText" id="prizeDisplay">?</div></div>
<p id="result"></p>

<h3>Dungeon</h3>
<canvas id="dungeonCanvas" width="480" height="480" style="border:3px solid white"></canvas>
<div id="mobileControls" class="hidden">
  <button onclick="movePlayer(0,-1)">⬆️</button>
  <div>
    <button onclick="movePlayer(-1,0)">⬅️</button>
    <button onclick="movePlayer(1,0)">➡️</button>
  </div>
  <button onclick="movePlayer(0,1)">⬇️</button>
  <button onclick="attack()">⚔️</button>
</div>

<h3>Inventory</h3>
<ul id="inventory"></ul>

<h3>Theme Selector</h3>
<select id="themeSelect" onchange="applyTheme(this.value)">
<option value="">--Choose Theme--</option>
</select>
</div>

<script>
/* === Endless Dungeon === */
const tileSize=32;
const mapSize=15;
let dungeonGame=null;

class DungeonGame{
  constructor(user){
    this.user=user;
    this.canvas=document.getElementById("dungeonCanvas");
    this.ctx=this.canvas.getContext("2d");
    this.rooms={}; // store visited rooms
    this.player={x:7,y:7,roomX:0,roomY:0};
    this.lives=3;this.level=1;
    this.load();
    this.generateRoom(0,0);
    this.loop();
    window.addEventListener("keydown",e=>this.handleInput(e));
  }
  key(x,y){return x+","+y;}
  generateRoom(rx,ry){
    if(this.rooms[this.key(rx,ry)])return;
    let map=[];let enemies=[];let items=[];
    for(let y=0;y<mapSize;y++){
      let row=[];
      for(let x=0;x<mapSize;x++){
        row.push(Math.random()<0.2?"#":".");
      }
      map.push(row);
    }
    // keep center clear
    map[7][7]=".";
    // enemies
    for(let i=0;i<2+this.level;i++){
      enemies.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize)});
    }
    // items
    if(Math.random()<0.1)items.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize),type:"life"});
    if(Math.random()<0.3)items.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize),type:"points"});
    this.rooms[this.key(rx,ry)]={map,enemies,items};
  }
  currentRoom(){return this.rooms[this.key(this.player.roomX,this.player.roomY)];}
  draw(){
    let room=this.currentRoom();
    this.ctx.fillStyle="black";this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
    for(let y=0;y<mapSize;y++){
      for(let x=0;x<mapSize;x++){
        this.ctx.fillStyle=room.map[y][x]==="#"?"gray":"black";
        this.ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize);
      }
    }
    room.items.forEach(it=>{
      this.ctx.fillStyle=it.type==="life"?"red":"gold";
      this.ctx.fillRect(it.x*tileSize+8,it.y*tileSize+8,16,16);
    });
    this.ctx.fillStyle="green";
    room.enemies.forEach(e=>this.ctx.fillRect(e.x*tileSize+4,e.y*tileSize+4,24,24));
    this.ctx.fillStyle="cyan";
    this.ctx.fillRect(this.player.x*tileSize+4,this.player.y*tileSize+4,24,24);
    this.ctx.fillStyle="white";this.ctx.fillText("Lives:"+this.lives+" Lvl:"+this.level,10,15);
  }
  move(dx,dy){
    let room=this.currentRoom();
    let nx=this.player.x+dx,ny=this.player.y+dy;
    if(nx<0){this.player.roomX--;this.generateRoom(this.player.roomX,this.player.roomY);nx=mapSize-1;}
    if(nx>=mapSize){this.player.roomX++;this.generateRoom(this.player.roomX,this.player.roomY);nx=0;}
    if(ny<0){this.player.roomY--;this.generateRoom(this.player.roomX,this.player.roomY);ny=mapSize-1;}
    if(ny>=mapSize){this.player.roomY++;this.generateRoom(this.player.roomX,this.player.roomY);ny=0;}
    if(this.currentRoom().map[ny][nx]==="#")return;
    this.player.x=nx;this.player.y=ny;
    // check items
    let newItems=[];
    for(let it of this.currentRoom().items){
      if(it.x===nx&&it.y===ny){
        if(it.type==="life")this.lives++;
        if(it.type==="points")accounts[this.user].points+=10;
      } else newItems.push(it);
    }
    this.currentRoom().items=newItems;
    // check enemies
    for(let e of this.currentRoom().enemies){
      if(e.x===nx&&e.y===ny){this.lives--;if(this.lives<=0)this.gameOver();}
    }
  }
  moveEnemies(){
    let room=this.currentRoom();
    room.enemies.forEach(e=>{
      let dir=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
      let nx=e.x+dir[0],ny=e.y+dir[1];
      if(nx>=0&&ny>=0&&nx<mapSize&&ny<mapSize&&room.map[ny][nx]==="."){e.x=nx;e.y=ny;}
      if(nx===this.player.x&&ny===this.player.y){this.lives--;if(this.lives<=0)this.gameOver();}
    });
  }
  attack(){
    let room=this.currentRoom();
    room.enemies=room.enemies.filter(e=>{
      let dist=Math.abs(e.x-this.player.x)+Math.abs(e.y-this.player.y);
      return dist>1;
    });
  }
  handleInput(e){
    if(e.key==="w")this.move(0,-1);
    if(e.key==="s")this.move(0,1);
    if(e.key==="a")this.move(-1,0);
    if(e.key==="d")this.move(1,0);
    if(e.key===" ")this.attack();
  }
  loop(){
    if(!dungeonGame)return;
    this.moveEnemies();
    this.draw();
    this.save();
    requestAnimationFrame(()=>this.loop());
  }
  save(){
    accounts[this.user].dungeon={lives:this.lives,player:this.player,rooms:this.rooms};
    saveData();
  }
  load(){
    let save=accounts[this.user].dungeon;
    if(save){this.lives=save.lives;this.player=save.player;this.rooms=save.rooms||{};}
  }
  gameOver(){
    if(accounts[this.user].points>=100){
      if(confirm("You died! Spend 100 points to revive?")){
        accounts[this.user].points-=100;this.lives=3;
      } else {this.reset();}
    } else this.reset();
  }
  reset(){
    alert("Progress lost!");accounts[this.user].dungeon=null;saveData();this.lives=3;this.player={x:7,y:7,roomX:0,roomY:0};this.rooms={};this.generateRoom(0,0);
  }
}

function movePlayer(dx,dy){if(dungeonGame)dungeonGame.move(dx,dy);}
function attack(){if(dungeonGame)dungeonGame.attack();}

/* Hook into login */
function startDungeon(){
  dungeonGame=new DungeonGame(currentUser);
}

</script>
</body>
</html>
