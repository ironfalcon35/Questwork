<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Questwork 4.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin:0;
    font-family:'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#1f1c2c 0%,#928DAB 100%);
    color:#fff;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    flex-direction:column;
    text-align:center;
    transition:background 0.5s ease;
  }
  .card {
    background: rgba(0,0,0,0.6);
    padding:20px;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
    max-width:550px;
    width:95%;
    margin:10px auto;
    animation:fadeIn 0.5s ease-in;
  }
  h2,h3{margin-top:0;color:#ffdd57;text-shadow:1px 1px 4px #000;}
  input,button,select{
    width:90%;padding:12px;margin:8px 0;border-radius:8px;border:none;font-size:1rem;outline:none;
  }
  input{background:#f4f4f4;color:black;}
  button{
    background: linear-gradient(135deg,#ff6a00,#ee0979);
    color:white;font-weight:bold;cursor:pointer;transition:transform 0.2s,opacity 0.3s;
  }
  button:hover{transform:scale(1.05);opacity:0.9;}
  .hidden{display:none;}
  #inventory{list-style:none;padding:0;margin:0;max-height:150px;overflow-y:auto;}
  #inventory li{
    background: rgba(255,255,255,0.1);
    margin:5px 0;
    padding:8px;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .delete-btn{
    background: crimson;color:white;border:none;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:0.8rem;
  }
  #wheelBox{
    margin:20px auto;
    width:250px;
    height:60px;
    overflow:hidden;
    border:3px solid #fff;
    border-radius:8px;
    background: rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .prizeText{
    font-size:1.4rem;font-weight:bold;
    transition:transform 0.15s ease;
  }
  .theme-dog{background:url('https://i.imgur.com/9i5G79G.jpg') center/cover;}
  .theme-pirate{background:url('https://i.imgur.com/m5mG93q.jpeg') center/cover;}
  .theme-neon{background:linear-gradient(135deg,#0f0f0f,#00ffcc);}
  .theme-spooky{background:url('https://i.imgur.com/jyCOb3u.jpg') center/cover;}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(10px);}
    to{opacity:1;transform:translateY(0);}
  }
  #teacherLoginBtn{
    width:auto;
    padding:6px 12px;
    font-size:0.9rem;
    margin-top:15px;
    background:linear-gradient(135deg,#555,#999);
  }
  #teacherPanel{margin-top:20px;}
  /* Dungeon game styling */
  #dungeonContainer{margin-top:20px;display:flex;flex-direction:column;align-items:center;}
  #mobileControls button{margin:2px;padding:10px;font-size:1.2rem;}
</style>
</head>
<body>
<div class="card" id="loginCard">
<h2>Questwork Login</h2>
<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">
<button onclick="signup()">Sign Up</button>
<button onclick="login()">Sign In</button>
</div>

<div class="card hidden" id="gameBox">
<h2>Welcome, <span id="playerName"></span>!</h2>
<p>⭐ Points: <span id="points">0</span></p>

<div id="wheelButtons">
<button onclick="spin()">Spin Wheel</button>
</div>

<div id="wheelBox"><div class="prizeText" id="prizeDisplay">?</div></div>
<p id="result"></p>

<button onclick="startDungeon()">Play Dungeon</button>

<!-- Dungeon game container -->
<div id="dungeonContainer" class="hidden">
  <canvas id="dungeonCanvas" width="480" height="480" style="border:3px solid white"></canvas>
  <div id="mobileControls" class="hidden">
    <button onclick="movePlayer(0,-1)">⬆️</button>
    <div>
      <button onclick="movePlayer(-1,0)">⬅️</button>
      <button onclick="movePlayer(1,0)">➡️</button>
    </div>
    <button onclick="movePlayer(0,1)">⬇️</button>
  </div>
  <button onclick="exitDungeon()">Exit Dungeon</button>
  <button onclick="toggleFullscreen()">Fullscreen</button>
</div>

<h3>Inventory</h3>
<ul id="inventory"></ul>

<h3>Theme Selector</h3>
<select id="themeSelect" onchange="applyTheme(this.value)">
<option value="">--Choose Theme--</option>
</select>

<button id="teacherLoginBtn" onclick="showTeacherLogin()">Teacher</button>
<div id="teacherPanel" class="hidden">
  <h3>Teacher Controls</h3>
  <input type="number" id="pointsToAdd" placeholder="Points to add">
  <button onclick="addPoints()">Add Points</button>
  <button onclick="logoutTeacher()">Log Out</button>
</div>
</div>

<script>
/* ========================== Dungeon Game ========================== */
const tileSize=32;
const mapSize=15;
let dungeonGame=null;

function startDungeon(){
  document.getElementById("gameBox").classList.add("hidden");
  document.getElementById("dungeonContainer").classList.remove("hidden");
  if(!accounts[currentUser].dungeon){
    accounts[currentUser].dungeon={lives:3,points:0,level:1};
  }
  dungeonGame=new DungeonGame(currentUser);
  if(/Mobi|Android/i.test(navigator.userAgent)){
    document.getElementById("mobileControls").classList.remove("hidden");
  }
}

function exitDungeon(){
  dungeonGame=null;
  saveData();
  document.getElementById("dungeonContainer").classList.add("hidden");
  document.getElementById("gameBox").classList.remove("hidden");
}

function toggleFullscreen(){
  const canvas=document.getElementById("dungeonCanvas");
  if(!document.fullscreenElement){
    canvas.requestFullscreen();
  } else {document.exitFullscreen();}
}

class DungeonGame{
  constructor(user){
    this.user=user;
    this.canvas=document.getElementById("dungeonCanvas");
    this.ctx=this.canvas.getContext("2d");
    this.map=[];
    this.player={x:7,y:7};
    this.enemies=[];
    this.items=[];
    this.load();
    this.generateRoom();
    this.loop();
    this.keyDownHandler=e=>this.handleInput(e);
    window.addEventListener("keydown",this.keyDownHandler);
  }
  load(){
    let save=accounts[this.user].dungeon;
    this.lives=save.lives;
    this.level=save.level;
  }
  save(){
    accounts[this.user].dungeon={lives:this.lives,level:this.level};
    saveData();
  }
  generateRoom(){
    this.map=[];
    for(let y=0;y<mapSize;y++){
      let row=[];
      for(let x=0;x<mapSize;x++){
        row.push(Math.random()<0.2?"#":".");
      }
      this.map.push(row);
    }
    this.map[this.player.y][this.player.x]=".";
    // Enemies
    this.enemies=[];
    for(let i=0;i<3+this.level;i++){
      this.enemies.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize)});
    }
    // Items
    this.items=[];
    if(Math.random()<0.25)this.items.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize),type:"life"});
    if(Math.random()<0.4)this.items.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize),type:"points"});
    if(Math.random()<0.05)this.items.push({x:Math.floor(Math.random()*mapSize),y:Math.floor(Math.random()*mapSize),type:"extraLife"});
  }
  draw(){
    this.ctx.fillStyle="black";this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
    for(let y=0;y<mapSize;y++){
      for(let x=0;x<mapSize;x++){
        this.ctx.fillStyle=this.map[y][x]==="#"?"gray":"black";
        this.ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize);
      }
    }
    // Items
    this.items.forEach(it=>{
      this.ctx.fillStyle=it.type==="life"?"red":it.type==="points"?"gold":"magenta";
      this.ctx.fillRect(it.x*tileSize+8,it.y*tileSize+8,16,16);
    });
    // Enemies
    this.ctx.fillStyle="green";
    this.enemies.forEach(e=>this.ctx.fillRect(e.x*tileSize+4,e.y*tileSize+4,24,24));
    // Player
    this.ctx.fillStyle="cyan";
    this.ctx.fillRect(this.player.x*tileSize+4,this.player.y*tileSize+4,24,24);
    // HUD
    this.ctx.fillStyle="white";
    this.ctx.font="16px Arial";
    this.ctx.fillText(`Lives:${this.lives} Level:${this.level} Points:${accounts[this.user].points}`,10,16);
  }
  move(dx,dy){
    let nx=this.player.x+dx,ny=this.player.y+dy;
    if(nx<0||ny<0||nx>=mapSize||ny>=mapSize)return;
    if(this.map[ny][nx]==="#")return;
    this.player.x=nx;this.player.y=ny;

    // Check items
    this.items=this.items.filter(it=>{
      if(it.x===nx&&it.y===ny){
        if(it.type==="life")this.lives++;
        else if(it.type==="points")accounts[this.user].points+=10;
        else if(it.type==="extraLife"){this.lives++;accounts[this.user].points+=50;}
        return false;
      }
      return true;
    });
    // Check enemies
    for(let e of this.enemies){
      if(e.x===nx&&e.y===ny){
        this.lives--;
        if(this.lives<=0){this.gameOver();return;}
      }
    }
  }
  handleInput(e){
    if(e.key==="w")this.move(0,-1);
    if(e.key==="s")this.move(0,1);
    if(e.key==="a")this.move(-1,0);
    if(e.key==="d")this.move(1,0);
  }
  moveEnemies(){
    this.enemies.forEach(e=>{
      let dir=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
      let nx=e.x+dir[0],ny=e.y+dir[1];
      if(nx>=0&&ny>=0&&nx<mapSize&&ny<mapSize&&this.map[ny][nx]==="."){e.x=nx;e.y=ny;}
      if(e.x===this.player.x&&e.y===this.player.y){
        this.lives--;
        if(this.lives<=0)this.gameOver();
      }
    });
  }
  loop(){
    if(!dungeonGame)return;
    this.moveEnemies();
    this.draw();
    this.save();
    requestAnimationFrame(()=>this.loop());
  }
  gameOver(){
    if(accounts[this.user].points>=100){
      if(confirm("You died! Spend 100 points to revive?")){
        accounts[this.user].points-=100;
        this.lives=3;
        return;
      }
    }
    alert("You died! Progress lost!");
    accounts[this.user].dungeon=null;
    exitDungeon();
  }
}

function movePlayer(dx,dy){if(dungeonGame)dungeonGame.move(dx,dy);}

/* ========================== Existing Code (Login/Wheel/Inventory) ========================== */
const TEACHER_SECRET="QUEST123";
const wheelPrizes=[
  {name:"Sticker Pack",weight:4,refund:2},
  {name:"Dog Theme",weight:2,type:"theme"},
  {name:"Pencil Upgrade",weight:3},
  {name:"Pirate Theme",weight:1,type:"theme"},
  {name:"Neon Theme",weight:1,type:"theme"},
  {name:"Spooky Theme",weight:1,type:"theme"},
  {name:"1 Bonus Point",weight:2,type:"points",amount:1},
  {name:"50 Bonus Points",weight:1,type:"points",amount:50}
];
let accounts=JSON.parse(localStorage.getItem("accounts"))||{};
let currentUser=null;
let teacherMode=false;

function saveData(){localStorage.setItem("accounts",JSON.stringify(accounts));}

function signup(){
  let u=document.getElementById("username").value;
  let p=document.getElementById("password").value;
  if(!u||!p)return alert("Enter username and password.");
  if(accounts[u])return alert("Account exists!");
  accounts[u]={password:p,points:0,inventory:[],themes:[],selectedTheme:""};
  saveData();currentUser=u;startGame();
}

function login(){
  let u=document.getElementById("username").value;
  let p=document.getElementById("password").value;
  if(!accounts[u])return alert("No account. Sign up first.");
  if(accounts[u].password!==p)return alert("Wrong password.");
  currentUser=u;startGame();
}

function startGame(){
  document.getElementById("playerName").innerText=currentUser;
  updateUI();
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("gameBox").classList.remove("hidden");
}

function weightedRandom(items){
  let total=items.reduce((sum,i)=>sum+i.weight,0);
  let r=Math.random()*total;
  for(let i of items){if(r<i.weight)return i;r-=i.weight;}
}

function spin(){
  let acc=accounts[currentUser];
  if(acc.points<5)return alert("Not enough points!");
  acc.points-=5;

  let prize=weightedRandom(wheelPrizes);
  let prizeDisplay=document.getElementById("prizeDisplay");
  let result=document.getElementById("result");

  let flips=30,step=0,interval=50;
  let anim=setInterval(()=>{
    step++;
    let fake=wheelPrizes[Math.floor(Math.random()*wheelPrizes.length)].name;
    prizeDisplay.innerText=fake;
    let scale=1+0.2*Math.sin(step*0.8);
    prizeDisplay.style.transform=`scale(${scale})`;
    if(step>=flips){
      clearInterval(anim);
      prizeDisplay.innerText=prize.name;
      prizeDisplay.style.transform="scale(1)";
      let acc=accounts[currentUser];
      let already=acc.inventory.includes(prize.name)||acc.themes.includes(prize.name.split(" ")[0].toLowerCase());
      if(already&&prize.type!=="points"){
        acc.points+=prize.refund||5;
        result.innerText=`Duplicate! Refunded ${prize.refund||5} pts.`;
      } else{
        if(prize.type==="points")acc.points+=prize.amount;
        else if(prize.type==="theme")acc.themes.push(prize.name.split(" ")[0].toLowerCase());
        else acc.inventory.push(prize.name);
        result.innerText=`🎉 You won: ${prize.name}`;
      }
      updateUI();
    }
    interval+=10;
  },interval);
}

function updateUI(){
  let acc=accounts[currentUser];
  document.getElementById("points").innerText=acc.points;
  let inv=document.getElementById("inventory");
  inv.innerHTML="";
  acc.inventory.forEach((item,idx)=>{
    let li=document.createElement("li");li.innerText=item;
    let del=document.createElement("button");del.innerText="x";del.className="delete-btn";
    del.onclick=()=>{acc.inventory.splice(idx,1);updateUI();}
    li.appendChild(del);inv.appendChild(li);
  });
  let themeSelect=document.getElementById("themeSelect");
  themeSelect.innerHTML="<option value=''>--Choose Theme--</option>";
  acc.themes.forEach(t=>{
    let opt=document.createElement("option");opt.value=t;opt.innerText=t[0].toUpperCase()+t.slice(1)+" Theme";
    if(t===acc.selectedTheme)opt.selected=true;
    themeSelect.appendChild(opt);
  });
  if(acc.selectedTheme)applyTheme(acc.selectedTheme);
  saveData();
}

function applyTheme(theme){
  let acc=accounts[currentUser];
  acc.selectedTheme=theme;
  document.body.className="";
  if(theme)document.body.classList.add("theme-"+theme);
  saveData();
}

/* Teacher controls */
function showTeacherLogin(){
  if(teacherMode) return;
  let code=prompt("Enter teacher code:");
  if(code===TEACHER_SECRET){
    teacherMode=true;
    document.getElementById("teacherPanel").classList.remove("hidden");
    document.getElementById("teacherLoginBtn").classList.add("hidden");
  } else { alert("Wrong code!"); }
}
function addPoints(){
  let amt=parseInt(document.getElementById("pointsToAdd").value);
  if(teacherMode&&amt>0){accounts[currentUser
